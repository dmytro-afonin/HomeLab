#!/usr/bin/env bash
# HomeLab CLI
# Usage: hl <command> [options]

set -euo pipefail

# Resolve symlinks to get actual script location
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Set HOMELAB_HOME if not already set
export HOMELAB_HOME="${HOMELAB_HOME:-$SCRIPT_DIR}"

source "$SCRIPT_DIR/scripts/lib/log.sh"

# Run doctor check (non-verbose by default)
# This ensures all dependencies are available before running commands
run_doctor_check() {
  "$SCRIPT_DIR/scripts/utils/doctor.sh" || exit 1
}

# Show help
show_help() {
  echo ""
  echo "HomeLab CLI v$HOMELAB_VERSION"
  echo ""
  echo "USAGE"
  echo "    hl <command> [options]"
  echo ""
  echo "COMMANDS"
  echo "    start [options]    Start all services"
  echo "        --allow-sleep, -as       Don't prevent Mac from sleeping"
  echo "        --allow-sleep-force, -asf  Also kill running caffeinate"
  echo "    stop               Stop all services"
  echo "    restart [options]  Restart all services"
  echo "    status             Show status of all services"
  echo ""
  echo "    logs [options]     View logs"
  echo "        -n, --limit N      Show last N entries (default: 50)"
  echo "        -s, --service NAME Filter by service"
  echo "        -l, --level LEVEL  Filter by level (INFO, WARN, ERROR)"
  echo "        --tail             Follow logs in real-time"
  echo "        --stats            Show log statistics"
  echo "        --clear            Clear all logs"
  echo ""
  echo "    auto-start         Enable auto-start on login"
  echo "    auto-start --off   Disable auto-start on login"
  echo ""
  echo "    webui <command>    WebUI configuration"
  echo "        buffer-size [N]      Set stream buffer size (default: 10 MB)"
  echo "        list-env             Show current configuration"
  echo "    ip                 Show local IP for network access"
  echo "    open               Open WebUI in browser"
  echo "    doctor [-v]        Check system requirements"
  echo "    upgrade            Upgrade to latest version"
  echo "    uninstall          Remove HomeLab completely"
  echo "    setup              Add 'hl' command to PATH"
  echo "    version            Show version info"
  echo "    help               Show this help"
  echo ""
  echo "EXAMPLES"
  echo "    hl start                      # Start everything"
  echo "    hl start --allow-sleep        # Start without caffeinate"
  echo "    hl status                     # Check all services"
  echo "    hl logs -n 100                # Last 100 log entries"
  echo "    hl logs --tail                # Follow logs live"
  echo "    hl doctor -v                  # Full system diagnostics"
  echo "    hl auto-start                 # Enable auto-start on login"
  echo ""
}

# Show version
show_version() {
  echo "HomeLab v$HOMELAB_VERSION"
  echo "Library v$HOMELAB_LIB_VERSION"
}

# Start all services
cmd_start() {
  local allow_sleep=false
  local force_sleep=false
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
      --allow-sleep|-as)
        allow_sleep=true
        shift
        ;;
      --allow-sleep-force|-asf)
        allow_sleep=true
        force_sleep=true
        shift
        ;;
      *)
        echo "‚ùå Unknown option: $1"
        exit 1
        ;;
    esac
  done
  
  run_doctor_check
  
  # Skip startup delay for manual runs
  export HOMELAB_STARTUP_DELAY=0
  
  if ! $allow_sleep; then
    "$SCRIPT_DIR/scripts/services/ensure-caffeinate.sh"
  else
    if $force_sleep; then
      # Kill any running caffeinate processes
      if pgrep -x caffeinate >/dev/null 2>&1; then
        echo "üí§ Stopping caffeinate..."
        pkill -x caffeinate 2>/dev/null || true
        log_info "caffeinate" "Stopped (force sleep mode)"
        echo "‚úÖ caffeinate stopped"
      else
        echo "üí§ caffeinate not running"
      fi
    else
      echo "üí§ Skipping caffeinate (Mac may sleep)"
    fi
  fi
  
  "$SCRIPT_DIR/scripts/services/ensure-lmstudio.sh"
  "$SCRIPT_DIR/scripts/services/ensure-containers.sh"
  echo ""
  echo "üéâ All services started!"
}

# Stop all services
cmd_stop() {
  run_doctor_check
  "$SCRIPT_DIR/scripts/services/stop-all.sh"
}

# Restart services
cmd_restart() {
  local args=("$@")
  cmd_stop
  echo ""
  cmd_start "${args[@]}"
}

# Show status
cmd_status() {
  run_doctor_check
  "$SCRIPT_DIR/scripts/utils/health-check.sh"
}

# Logs command
cmd_logs() {
  local args=()
  local tail_mode=false
  local stats_mode=false
  local clear_mode=false
  
  while [[ $# -gt 0 ]]; do
    case $1 in
      --tail|-f)
        tail_mode=true
        shift
        ;;
      --stats)
        stats_mode=true
        shift
        ;;
      --clear)
        clear_mode=true
        shift
        ;;
      *)
        args+=("$1")
        shift
        ;;
    esac
  done
  
  if $clear_mode; then
    "$SCRIPT_DIR/scripts/logs/clear.sh"
  elif $stats_mode; then
    "$SCRIPT_DIR/scripts/logs/stats.sh"
  elif $tail_mode; then
    "$SCRIPT_DIR/scripts/logs/tail.sh"
  else
    "$SCRIPT_DIR/scripts/logs/view.sh" "${args[@]}"
  fi
}

# Auto-start (LaunchAgent)
cmd_autostart() {
  local disable=false
  
  while [[ $# -gt 0 ]]; do
    case $1 in
      --off|--disable)
        disable=true
        shift
        ;;
      *)
        echo "‚ùå Unknown option: $1"
        exit 1
        ;;
    esac
  done
  
  local plist_path="$HOME/Library/LaunchAgents/com.homelab.start.plist"
  
  if $disable; then
    if [ -f "$plist_path" ]; then
      echo "üîÑ Disabling auto-start..."
      launchctl unload "$plist_path" 2>/dev/null || true
      rm -f "$plist_path"
      log_info "autostart" "Auto-start disabled"
      echo "‚úÖ Auto-start disabled"
    else
      echo "‚ö†Ô∏è  Auto-start is not enabled"
    fi
  else
    run_doctor_check
    "$SCRIPT_DIR/install-launchagent.sh"
  fi
}

# Show local IP
cmd_ip() {
  "$SCRIPT_DIR/scripts/utils/local-ip.sh"
}

# Open WebUI
cmd_open() {
  echo "üåê Opening WebUI..."
  open "http://localhost:3000"
}

# Doctor - check system requirements
cmd_doctor() {
  local verbose=""
  
  while [[ $# -gt 0 ]]; do
    case $1 in
      --verbose|-v)
        verbose="--verbose"
        shift
        ;;
      *)
        shift
        ;;
    esac
  done
  
  "$SCRIPT_DIR/scripts/utils/doctor.sh" $verbose
}

# Setup - add to PATH
cmd_setup() {
  run_doctor_check
  "$SCRIPT_DIR/scripts/setup/add-to-path.sh"
}

# WebUI command dispatcher
cmd_webui() {
  local subcmd="${1:-}"
  shift || true
  
  case "$subcmd" in
    buffer-size|buffer)
      cmd_webui_buffer_size "$@"
      ;;
    list-env|env)
      cmd_webui_list_env
      ;;
    *)
      echo "‚ùå Unknown webui command: $subcmd"
      echo ""
      echo "Usage: hl webui <command>"
      echo ""
      echo "Commands:"
      echo "    buffer-size [N]    Set stream buffer size (default: 10 MB)"
      echo "        -u, --unit     Size unit: mb, kb, b (default: mb)"
      echo "    list-env           Show current WebUI configuration"
      echo ""
      exit 1
      ;;
  esac
}

# WebUI list-env - show current configuration
cmd_webui_list_env() {
  local env_file="$HOMELAB_HOME/.env"
  
  echo ""
  echo "üìã WebUI Configuration"
  echo "======================"
  echo ""
  echo "File: $env_file"
  echo ""
  
  if [ ! -f "$env_file" ]; then
    echo "‚ùå Configuration file not found"
    exit 1
  fi
  
  # Show non-empty, non-comment lines
  while IFS= read -r line || [ -n "$line" ]; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
    
    # Parse key=value
    if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
      local key="${BASH_REMATCH[1]}"
      local value="${BASH_REMATCH[2]}"
      printf "%-45s = %s\n" "$key" "$value"
    fi
  done < "$env_file"
  
  echo ""
}

# WebUI buffer-size - set stream buffer size for fast models
cmd_webui_buffer_size() {
  local size=""
  local unit="mb"
  local env_file="$HOMELAB_HOME/.env"
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
      --unit=*|-u=*)
        unit="${1#*=}"
        shift
        ;;
      -u)
        unit="$2"
        shift 2
        ;;
      --unit)
        unit="$2"
        shift 2
        ;;
      -*)
        echo "‚ùå Unknown option: $1"
        echo "Usage: hl fix-streaming [SIZE] [--unit=mb|kb|b]"
        exit 1
        ;;
      *)
        size="$1"
        shift
        ;;
    esac
  done
  
  # Default size is 10
  size="${size:-10}"
  
  # Normalize unit
  case "$unit" in
    mb|m|MB|M)
      unit="MB"
      bytes=$((size * 1024 * 1024))
      ;;
    kb|k|KB|K)
      unit="KB"
      bytes=$((size * 1024))
      ;;
    b|B|byte|bytes)
      unit="bytes"
      bytes=$size
      ;;
    *)
      echo "‚ùå Unknown unit: $unit"
      echo "   Supported: mb, kb, b (or m, k, b)"
      exit 1
      ;;
  esac
  
  echo "üîß Setting stream buffer size to $size $unit ($bytes bytes)..."
  
  if [ ! -f "$env_file" ]; then
    echo "‚ùå Configuration file not found: $env_file"
    exit 1
  fi
  
  # Update or add the buffer size setting
  if grep -q "CHAT_STREAM_RESPONSE_CHUNK_MAX_BUFFER_SIZE" "$env_file"; then
    # Update existing
    sed -i '' "s/CHAT_STREAM_RESPONSE_CHUNK_MAX_BUFFER_SIZE=.*/CHAT_STREAM_RESPONSE_CHUNK_MAX_BUFFER_SIZE=$bytes/" "$env_file"
  else
    # Add new
    echo "CHAT_STREAM_RESPONSE_CHUNK_MAX_BUFFER_SIZE=$bytes" >> "$env_file"
  fi
  
  log_info "config" "Buffer size set to $size $unit ($bytes bytes)"
  
  echo "‚úÖ Buffer size set to $size $unit"
  echo ""
  echo "‚ö†Ô∏è  Restart services to apply changes:"
  echo ""
  echo "   hl restart"
  echo ""
}

# Uninstall HomeLab completely
cmd_uninstall() {
  echo ""
  echo "üóëÔ∏è  Uninstall HomeLab"
  echo "===================="
  echo ""
  echo "This will remove:"
  echo "  - LaunchAgent (auto-start)"
  echo "  - Installation directory: $HOMELAB_HOME"
  echo "  - Symlink: /usr/local/bin/hl (if exists)"
  echo ""
  
  read -p "Are you sure? [y/N] " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
  fi
  
  echo ""
  
  # Stop services first
  echo "Stopping services..."
  "$SCRIPT_DIR/scripts/services/stop-all.sh" 2>/dev/null || true
  
  # Remove LaunchAgent
  local plist_path="$HOME/Library/LaunchAgents/com.homelab.start.plist"
  if [ -f "$plist_path" ]; then
    echo "Removing LaunchAgent..."
    launchctl unload "$plist_path" 2>/dev/null || true
    rm -f "$plist_path"
  fi
  
  # Remove symlink
  if [ -L "/usr/local/bin/hl" ]; then
    echo "Removing symlink (requires sudo)..."
    sudo rm -f /usr/local/bin/hl
  fi
  
  # Remove installation directory
  if [ -d "$HOMELAB_HOME" ] && [ "$HOMELAB_HOME" != "$HOME" ]; then
    echo "Removing $HOMELAB_HOME..."
    rm -rf "$HOMELAB_HOME"
  fi
  
  echo ""
  echo "‚úÖ HomeLab uninstalled"
  echo ""
  echo "Note: Docker containers and images were not removed."
  echo "To remove them: docker compose down -v --rmi all"
  echo ""
}

# Upgrade HomeLab to latest version
cmd_upgrade() {
  echo ""
  echo "‚¨ÜÔ∏è  Upgrading HomeLab"
  echo "===================="
  echo ""
  
  local repo_url="https://github.com/dmytro-afonin/HomeLab"
  local temp_dir=$(mktemp -d)
  
  echo "Downloading latest version..."
  if ! git clone --depth 1 "$repo_url" "$temp_dir" 2>/dev/null; then
    echo "‚ùå Failed to download. Check your internet connection."
    rm -rf "$temp_dir"
    exit 1
  fi
  
  local new_version=$(cat "$temp_dir/VERSION" 2>/dev/null | tr -d '\n')
  local current_version="$HOMELAB_VERSION"
  
  echo "Current version: $current_version"
  echo "Latest version:  $new_version"
  echo ""
  
  if [ "$new_version" = "$current_version" ]; then
    echo "‚úÖ Already up to date!"
    rm -rf "$temp_dir"
    exit 0
  fi
  
  echo "Updating files..."
  
  # Backup .env
  local env_backup=""
  if [ -f "$HOMELAB_HOME/.env" ]; then
    env_backup=$(cat "$HOMELAB_HOME/.env")
  fi
  
  # Copy new files
  cp -r "$temp_dir"/scripts/* "$HOMELAB_HOME/scripts/"
  cp "$temp_dir/hl" "$HOMELAB_HOME/"
  cp "$temp_dir/start.sh" "$HOMELAB_HOME/"
  cp "$temp_dir/VERSION" "$HOMELAB_HOME/"
  cp "$temp_dir/docker-compose.yml" "$HOMELAB_HOME/"
  cp "$temp_dir/.env.example" "$HOMELAB_HOME/"
  cp "$temp_dir/com.homelab.start.plist.template" "$HOMELAB_HOME/"
  cp "$temp_dir/install-launchagent.sh" "$HOMELAB_HOME/"
  
  # Restore .env
  if [ -n "$env_backup" ]; then
    echo "$env_backup" > "$HOMELAB_HOME/.env"
  fi
  
  # Make executable
  chmod +x "$HOMELAB_HOME/hl"
  chmod +x "$HOMELAB_HOME/start.sh"
  chmod +x "$HOMELAB_HOME"/scripts/**/*.sh 2>/dev/null || true
  chmod +x "$HOMELAB_HOME"/scripts/*/*.sh 2>/dev/null || true
  chmod +x "$HOMELAB_HOME/install-launchagent.sh"
  
  # Cleanup
  rm -rf "$temp_dir"
  
  log_info "upgrade" "Upgraded from $current_version to $new_version"
  
  echo ""
  echo "‚úÖ Upgraded to v$new_version"
  echo ""
  echo "Restart services to apply changes:"
  echo ""
  echo "   hl restart"
  echo ""
}

# Main
main() {
  local cmd="${1:-help}"
  shift || true
  
  case "$cmd" in
    start)
      cmd_start "$@"
      ;;
    stop)
      cmd_stop
      ;;
    restart)
      cmd_restart "$@"
      ;;
    status|st)
      cmd_status
      ;;
    logs|log|l)
      cmd_logs "$@"
      ;;
    auto-start|autostart)
      cmd_autostart "$@"
      ;;
    ip)
      cmd_ip
      ;;
    open|o)
      cmd_open
      ;;
    doctor|doc|check)
      cmd_doctor "$@"
      ;;
    webui)
      cmd_webui "$@"
      ;;
    setup)
      cmd_setup
      ;;
    upgrade|update)
      cmd_upgrade
      ;;
    uninstall|remove)
      cmd_uninstall
      ;;
    version|v|-v|--version)
      show_version
      ;;
    help|h|-h|--help)
      show_help
      ;;
    *)
      echo "‚ùå Unknown command: $cmd"
      echo ""
      show_help
      exit 1
      ;;
  esac
}

main "$@"
